
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A Python package for finding intertextual links in Latin literature using pre-trained language models.">
      
      
      
        <link rel="canonical" href="https://julian-schelb.github.io/locisimiles/api/pipelines/">
      
      
        <link rel="prev" href="../document/">
      
      
        <link rel="next" href="../evaluator/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Pipelines - LociSimiles</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipelines-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LociSimiles" class="md-header__button md-logo" aria-label="LociSimiles" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LociSimiles
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pipelines
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/julian-schelb/locisimiles" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    julian-schelb/locisimiles
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LociSimiles" class="md-nav__button md-logo" aria-label="LociSimiles" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LociSimiles
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/julian-schelb/locisimiles" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    julian-schelb/locisimiles
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../document/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Document
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Pipelines
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipelines
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#retrieval-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retrieval Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;retrieval
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;RetrievalPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" RetrievalPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.build_source_index" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;build_source_index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.retrieve" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;retrieve
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.run" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classification-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classification Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;classification
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification.ClassificationPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClassificationPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClassificationPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification.ClassificationPipeline.debug_input_sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;debug_input_sequence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification.ClassificationPipeline.run" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#two-stage-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Two-Stage Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;two_stage
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClassificationPipelineWithCandidategeneration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClassificationPipelineWithCandidategeneration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.build_source_index" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;build_source_index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.check_candidates" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;check_candidates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.debug_input_sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;debug_input_sequence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.generate_candidates" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_candidates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.run" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type Definitions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline._types" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;_types
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline._types.pretty_print" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;pretty_print
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evaluator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#retrieval-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retrieval Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;retrieval
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;RetrievalPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" RetrievalPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.build_source_index" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;build_source_index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.retrieve" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;retrieve
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.run" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classification-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classification Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;classification
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification.ClassificationPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClassificationPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClassificationPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification.ClassificationPipeline.debug_input_sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;debug_input_sequence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.classification.ClassificationPipeline.run" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#two-stage-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Two-Stage Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;two_stage
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClassificationPipelineWithCandidategeneration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClassificationPipelineWithCandidategeneration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.build_source_index" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;build_source_index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.check_candidates" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;check_candidates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.debug_input_sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;debug_input_sequence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.generate_candidates" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_candidates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.run" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type Definitions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline._types" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;_types
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locisimiles.pipeline._types.pretty_print" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;pretty_print
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="pipelines-api">Pipelines API<a class="headerlink" href="#pipelines-api" title="Permanent link">&para;</a></h1>
<p>The pipeline module provides the main processing pipelines for intertextual detection.</p>
<h2 id="retrieval-pipeline">Retrieval Pipeline<a class="headerlink" href="#retrieval-pipeline" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="locisimiles.pipeline.retrieval"></a>
    <div class="doc doc-contents first">

        <p>Retrieval-only pipeline: Uses embedding similarity without classification.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="locisimiles.pipeline.retrieval.RetrievalPipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>              <code class="highlight language-python"><span class="n">RetrievalPipeline</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">embedding_model_name</span><span class="o">=</span><span class="s1">&#39;julian-schelb/SPhilBerta-emb-lat-intertext-v1&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.retrieval.RetrievalPipeline" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>A retrieval-only pipeline for intertextuality detection.</p>
<p>Uses embedding similarity to find candidate segments without a classification
stage. Binary decisions are made based on rank (top-k) or similarity threshold.</p>
<p>To maintain compatibility with the evaluator, results are returned in FullDict
format where the "probability" field is set to 1.0 for positive predictions
and 0.0 for negative predictions based on the decision criteria.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/locisimiles/pipeline/retrieval.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">embedding_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;julian-schelb/SPhilBerta-emb-lat-intertext-v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source_index</span><span class="p">:</span> <span class="n">chromadb</span><span class="o">.</span><span class="n">Collection</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="c1"># -------- Load Embedding Model ----------</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="n">embedding_model_name</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Keep results in memory for later access</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_sim</span><span class="p">:</span> <span class="n">SimDict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_full</span><span class="p">:</span> <span class="n">FullDict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.retrieval.RetrievalPipeline.build_source_index" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_source_index</span><span class="p">(</span><span class="n">source_segments</span><span class="p">,</span> <span class="n">source_embeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;source_segments&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.build_source_index" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create a Chroma collection from <em>source_segments</em> and their embeddings.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_source_index</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">source_segments</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TextSegment</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">source_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;source_segments&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="p">):</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Chroma collection from *source_segments* and their embeddings.&quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">chromadb</span><span class="o">.</span><span class="n">EphemeralClient</span><span class="p">()</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">unique_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">client</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">unique_name</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">pass</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">col</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">name</span><span class="o">=</span><span class="n">unique_name</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hnsw:space&quot;</span><span class="p">:</span> <span class="s2">&quot;cosine&quot;</span><span class="p">}</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_segments</span><span class="p">]</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">source_embeddings</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="k">return</span> <span class="n">col</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.retrieval.RetrievalPipeline.retrieve" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">retrieve</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">query_prompt_name</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="n">source_prompt_name</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.retrieve" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve candidate segments from <em>source</em> based on similarity to <em>query</em>.</p>
<p>Returns a dictionary mapping query segment IDs to lists of
(source segment, similarity score) pairs, sorted by similarity (descending).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">query</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">query_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">source_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimDict</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    Retrieve candidate segments from *source* based on similarity to *query*.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    Returns a dictionary mapping query segment IDs to lists of</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    (source segment, similarity score) pairs, sorted by similarity (descending).</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">query_segments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">source_segments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">query_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embed</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">query_segments</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding query segments&quot;</span><span class="p">)],</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">prompt_name</span><span class="o">=</span><span class="n">query_prompt_name</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">source_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embed</span><span class="p">(</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">source_segments</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding source segments&quot;</span><span class="p">)],</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">prompt_name</span><span class="o">=</span><span class="n">source_prompt_name</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_source_index</span><span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">source_segments</span><span class="o">=</span><span class="n">source_segments</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">source_embeddings</span><span class="o">=</span><span class="n">source_embeddings</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;source_segments&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">similarity_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_similarity</span><span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">query_segments</span><span class="o">=</span><span class="n">query_segments</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">query_embeddings</span><span class="o">=</span><span class="n">query_embeddings</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">source_document</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_sim</span> <span class="o">=</span> <span class="n">similarity_results</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="k">return</span> <span class="n">similarity_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.retrieval.RetrievalPipeline.run" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query_prompt_name</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="n">source_prompt_name</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.retrieval.RetrievalPipeline.run" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Run the retrieval pipeline and return results compatible with the evaluator.</p>
<p>Binary decisions are made using one of two criteria:
- <strong>top_k</strong> (default): The top-k ranked candidates per query are predicted 
  as positive (prob=1.0), all others as negative (prob=0.0).
- <strong>similarity_threshold</strong>: If provided, candidates with similarity &gt;= threshold
  are predicted as positive, regardless of rank.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="              Document(path, *, author=None, meta=None, segment_delimiter='\n') (locisimiles.document.Document)" href="../document/#locisimiles.document.Document">Document</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Query document</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="              Document(path, *, author=None, meta=None, segment_delimiter='\n') (locisimiles.document.Document)" href="../document/#locisimiles.document.Document">Document</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source document  </p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of top candidates to mark as positive (default: 10).
   Used when similarity_threshold is None.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>similarity_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, use this similarity cutoff instead
   of top_k. Candidates with similarity &gt;= threshold are positive.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query_prompt_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt name for query embeddings</p>
              </div>
            </td>
            <td>
                  <code>&#39;query&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_prompt_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt name for source embeddings</p>
              </div>
            </td>
            <td>
                  <code>&#39;match&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="locisimiles.pipeline._types.FullDict">FullDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>FullDict mapping query IDs to lists of (segment, similarity, probability)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="locisimiles.pipeline._types.FullDict">FullDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuples. Probability is 1.0 for positive predictions, 0.0 for negative.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/retrieval.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">query</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">query_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">source_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FullDict</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    Run the retrieval pipeline and return results compatible with the evaluator.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    Binary decisions are made using one of two criteria:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">    - **top_k** (default): The top-k ranked candidates per query are predicted </span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">      as positive (prob=1.0), all others as negative (prob=0.0).</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">    - **similarity_threshold**: If provided, candidates with similarity &gt;= threshold</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">      are predicted as positive, regardless of rank.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        query: Query document</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        source: Source document  </span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        top_k: Number of top candidates to mark as positive (default: 10).</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">               Used when similarity_threshold is None.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">        similarity_threshold: If provided, use this similarity cutoff instead</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">               of top_k. Candidates with similarity &gt;= threshold are positive.</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        query_prompt_name: Prompt name for query embeddings</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">        source_prompt_name: Prompt name for source embeddings</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        FullDict mapping query IDs to lists of (segment, similarity, probability)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        tuples. Probability is 1.0 for positive predictions, 0.0 for negative.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="c1"># Retrieve more candidates than top_k to ensure we have enough for evaluation</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="c1"># When using similarity_threshold, we need all candidates</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">retrieve_k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">if</span> <span class="n">similarity_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">top_k</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">similarity_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="n">top_k</span><span class="o">=</span><span class="n">retrieve_k</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">query_prompt_name</span><span class="o">=</span><span class="n">query_prompt_name</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">source_prompt_name</span><span class="o">=</span><span class="n">source_prompt_name</span><span class="p">,</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="c1"># Convert to FullDict format with binary &quot;probabilities&quot;</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">full_results</span><span class="p">:</span> <span class="n">FullDict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="k">for</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">similarity_pairs</span> <span class="ow">in</span> <span class="n">similarity_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">full_results</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">similarity</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">similarity_pairs</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># Determine if this candidate should be predicted as positive</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="k">if</span> <span class="n">similarity_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="c1"># Use similarity threshold</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="n">is_positive</span> <span class="o">=</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="c1"># Use top-k ranking (0-indexed, so rank &lt; top_k)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="n">is_positive</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">&lt;</span> <span class="n">top_k</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="c1"># Set probability to 1.0 for positive, 0.0 for negative</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">probability</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">is_positive</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="n">full_results</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">segment</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span> <span class="n">probability</span><span class="p">))</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_full</span> <span class="o">=</span> <span class="n">full_results</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">return</span> <span class="n">full_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="classification-pipeline">Classification Pipeline<a class="headerlink" href="#classification-pipeline" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="locisimiles.pipeline.classification"></a>
    <div class="doc doc-contents first">

        <p>Classification-only pipeline: Exhaustive pairwise comparison without retrieval.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="locisimiles.pipeline.classification.ClassificationPipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>              <code class="highlight language-python"><span class="n">ClassificationPipeline</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">classification_name</span><span class="o">=</span><span class="s1">&#39;julian-schelb/PhilBerta-class-latin-intertext-v1&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos_class_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.classification.ClassificationPipeline" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>A simpler pipeline for intertextuality classification without candidate generation.
It classifies all possible pairs between query and source segments without
a retrieval stage. Suitable for smaller document pairs or when exhaustive
comparison is needed.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/locisimiles/pipeline/classification.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">classification_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;julian-schelb/PhilBerta-class-latin-intertext-v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">pos_class_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Index of the positive class in the classifier</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">pos_class_idx</span> <span class="o">=</span> <span class="n">pos_class_idx</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="c1"># -------- Load Classification Model ----------</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clf_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">classification_name</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clf_model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">classification_name</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clf_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Keep results in memory for later access</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_results</span><span class="p">:</span> <span class="n">FullDict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.classification.ClassificationPipeline.debug_input_sequence" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">debug_input_sequence</span><span class="p">(</span><span class="n">query_text</span><span class="p">,</span> <span class="n">candidate_text</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.classification.ClassificationPipeline.debug_input_sequence" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Debug method to inspect how a query-candidate pair is encoded.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/classification.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="k">def</span><span class="w"> </span><span class="nf">debug_input_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">candidate_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Debug method to inspect how a query-candidate pair is encoded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="c1"># Truncate the pair</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">query_trunc</span><span class="p">,</span> <span class="n">candidate_trunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_pair</span><span class="p">(</span><span class="n">query_text</span><span class="p">,</span> <span class="n">candidate_text</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="c1"># Encode the pair</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf_tokenizer</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">query_trunc</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">candidate_trunc</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">max_length</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="c1"># Decode with special tokens visible</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">decoded_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query_text</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="s2">&quot;candidate&quot;</span><span class="p">:</span> <span class="n">candidate_text</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="s2">&quot;query_truncated&quot;</span><span class="p">:</span> <span class="n">query_trunc</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="s2">&quot;candidate_truncated&quot;</span><span class="p">:</span> <span class="n">candidate_trunc</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="s2">&quot;input_text&quot;</span><span class="p">:</span> <span class="n">decoded_text</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.classification.ClassificationPipeline.run" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.classification.ClassificationPipeline.run" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Run classification on all query-source segment pairs.
Returns a dictionary mapping query segment IDs to lists of
(source segment, similarity_score=None, P(positive)) tuples.</p>
<p>Note: Since there's no retrieval stage, similarity_score is set to None.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/classification.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">query</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FullDict</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    Run classification on all query-source segment pairs.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    Returns a dictionary mapping query segment IDs to lists of</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    (source segment, similarity_score=None, P(positive)) tuples.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">    Note: Since there&#39;s no retrieval stage, similarity_score is set to None.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">results</span><span class="p">:</span> <span class="n">FullDict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="c1"># Extract all source segments</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">source_segments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">source_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_segments</span><span class="p">]</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="c1"># For each query segment, classify against all source segments</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="k">for</span> <span class="n">query_segment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Classifying pairs&quot;</span><span class="p">):</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">query_text</span> <span class="o">=</span> <span class="n">query_segment</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="c1"># Predict probabilities for all source segments</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="n">query_text</span><span class="p">,</span> 
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="n">source_texts</span><span class="p">,</span> 
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="c1"># Build results with None for similarity score (no retrieval stage)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">results</span><span class="p">[</span><span class="n">query_segment</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="p">(</span><span class="n">source_seg</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="k">for</span> <span class="n">source_seg</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">source_segments</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="p">]</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_results</span> <span class="o">=</span> <span class="n">results</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="two-stage-pipeline">Two-Stage Pipeline<a class="headerlink" href="#two-stage-pipeline" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="locisimiles.pipeline.two_stage"></a>
    <div class="doc doc-contents first">

        <p>Two-stage pipeline: Retrieval (candidate generation) + Classification.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>              <code class="highlight language-python"><span class="n">ClassificationPipelineWithCandidategeneration</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">classification_name</span><span class="o">=</span><span class="s1">&#39;julian-schelb/PhilBerta-class-latin-intertext-v1&#39;</span><span class="p">,</span> <span class="n">embedding_model_name</span><span class="o">=</span><span class="s1">&#39;julian-schelb/SPhilBerta-emb-lat-intertext-v1&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos_class_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>A pipeline for intertextuality classification with candidate generation.
It first generates candidate segments from a source document based on
similarity to a query segment, and then classifies these candidates
as intertextual or not using a pre-trained model.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/locisimiles/pipeline/two_stage.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">classification_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;julian-schelb/PhilBerta-class-latin-intertext-v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">embedding_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;julian-schelb/SPhilBerta-emb-lat-intertext-v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">pos_class_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Index of the positive class in the classifier</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">pos_class_idx</span> <span class="o">=</span> <span class="n">pos_class_idx</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source_index</span><span class="p">:</span> <span class="n">chromadb</span><span class="o">.</span><span class="n">Collection</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="c1"># -------- Load Models ----------</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">embedder</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="n">embedding_model_name</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clf_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">classification_name</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clf_model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">classification_name</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clf_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Keep results in memory for later access</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_sim</span><span class="p">:</span> <span class="n">SimDict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_full</span><span class="p">:</span> <span class="n">FullDict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.build_source_index" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_source_index</span><span class="p">(</span><span class="n">source_segments</span><span class="p">,</span> <span class="n">source_embeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;source_segments&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.build_source_index" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create a Chroma collection from <em>source_segments</em> and their embeddings.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/two_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_source_index</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">source_segments</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TextSegment</span><span class="p">],</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">source_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;source_segments&quot;</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1"># Safe batch size</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="p">):</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Chroma collection from *source_segments* and their embeddings.&quot;&quot;&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="c1"># Use EphemeralClient for non-persistent, in-memory storage</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="c1"># Create new client each time to ensure clean state</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">chromadb</span><span class="o">.</span><span class="n">EphemeralClient</span><span class="p">()</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="c1"># Use unique collection name to avoid conflicts in same session</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">unique_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="c1"># Delete collection if it exists (should not happen with unique names, but just in case)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">client</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">unique_name</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">pass</span>  <span class="c1"># Collection doesn&#39;t exist, which is fine</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1"># Create fresh collection with unique name</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">col</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">name</span><span class="o">=</span><span class="n">unique_name</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hnsw:space&quot;</span><span class="p">:</span> <span class="s2">&quot;cosine&quot;</span><span class="p">}</span>  <span class="c1"># Use cosine distance</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="c1"># Extract IDs and embeddings</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_segments</span><span class="p">]</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">source_embeddings</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="c1"># Add segments to the collection in batches</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="k">return</span> <span class="n">col</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.check_candidates" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_candidates</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.check_candidates" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Classify candidates generated from <em>source</em>.
If <em>candidates</em> is not provided, it will be generated using
<em>generate_candidates</em>.
Returns a dictionary mapping query segment IDs to lists of
(source segment, similarity score, P(positive)) tuples.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/two_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_candidates</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">query</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="n">candidates</span><span class="p">:</span> <span class="n">SimDict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FullDict</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    Classify candidates generated from *source*.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">    If *candidates* is not provided, it will be generated using</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">    *generate_candidates*.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">    Returns a dictionary mapping query segment IDs to lists of</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">    (source segment, similarity score, P(positive)) tuples.</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="n">full_results</span><span class="p">:</span> <span class="n">FullDict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="k">for</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">similarity_pairs</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Check candidates&quot;</span><span class="p">):</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="c1"># Predict probabilities for the current query and its candidates</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="n">candidate_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">segment</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">similarity_pairs</span><span class="p">]</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">query</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">candidate_texts</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="c1"># Combine segments, similarity scores, and probabilities into results</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">full_results</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">similarity_score</span><span class="p">),</span> <span class="n">probability</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">similarity_pairs</span><span class="p">,</span> <span class="n">predicted_probabilities</span><span class="p">):</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">full_results</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">segment</span><span class="p">,</span> <span class="n">similarity_score</span><span class="p">,</span> <span class="n">probability</span><span class="p">))</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_full</span> <span class="o">=</span> <span class="n">full_results</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="k">return</span> <span class="n">full_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.debug_input_sequence" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">debug_input_sequence</span><span class="p">(</span><span class="n">query_text</span><span class="p">,</span> <span class="n">candidate_text</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.debug_input_sequence" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Debug method to inspect how a query-candidate pair is encoded.</p>
<p>Returns a dictionary with:
- query: Original query text
- candidate: Original candidate text
- query_truncated: Truncated query text
- candidate_truncated: Truncated candidate text
- input_ids: Token IDs as list
- input_text: Decoded text with special tokens visible
- attention_mask: Attention mask as list</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/two_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="k">def</span><span class="w"> </span><span class="nf">debug_input_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">candidate_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Debug method to inspect how a query-candidate pair is encoded.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    Returns a dictionary with:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    - query: Original query text</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    - candidate: Original candidate text</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">    - query_truncated: Truncated query text</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    - candidate_truncated: Truncated candidate text</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    - input_ids: Token IDs as list</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    - input_text: Decoded text with special tokens visible</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    - attention_mask: Attention mask as list</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="c1"># Truncate the pair</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">query_trunc</span><span class="p">,</span> <span class="n">candidate_trunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_pair</span><span class="p">(</span><span class="n">query_text</span><span class="p">,</span> <span class="n">candidate_text</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="c1"># Encode the pair</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf_tokenizer</span><span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">query_trunc</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">candidate_trunc</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">max_length</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="c1"># Decode with special tokens visible</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">decoded_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query_text</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="s2">&quot;candidate&quot;</span><span class="p">:</span> <span class="n">candidate_text</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="s2">&quot;query_truncated&quot;</span><span class="p">:</span> <span class="n">query_trunc</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="s2">&quot;candidate_truncated&quot;</span><span class="p">:</span> <span class="n">candidate_trunc</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="s2">&quot;input_text&quot;</span><span class="p">:</span> <span class="n">decoded_text</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.generate_candidates" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate_candidates</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">query_prompt_name</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="n">source_prompt_name</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.generate_candidates" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate candidate segments from <em>source</em> based on similarity to <em>query</em>.
Returns a dictionary mapping query segment IDs to lists of
(source segment, similarity score) pairs.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/two_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_candidates</span><span class="p">(</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">query</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">query_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">source_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimDict</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    Generate candidate segments from *source* based on similarity to *query*.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    Returns a dictionary mapping query segment IDs to lists of</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    (source segment, similarity score) pairs.</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="c1"># Extract segments from query and source documents</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">query_segments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="n">source_segments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="c1"># Embed query and source segments</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="n">query_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embed</span><span class="p">(</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">query_segments</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding query segments&quot;</span><span class="p">)],</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">prompt_name</span><span class="o">=</span><span class="n">query_prompt_name</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="c1"># Embed source segments with a progress bar</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="n">source_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embed</span><span class="p">(</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">source_segments</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding source segments&quot;</span><span class="p">)],</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">prompt_name</span><span class="o">=</span><span class="n">source_prompt_name</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="c1"># Build the source index for fast retrieval</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_source_index</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">source_segments</span><span class="o">=</span><span class="n">source_segments</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">source_embeddings</span><span class="o">=</span><span class="n">source_embeddings</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;source_segments&quot;</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="c1"># Compute similarity between query and source segments</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="n">similarity_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_similarity</span><span class="p">(</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">query_segments</span><span class="o">=</span><span class="n">query_segments</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">query_embeddings</span><span class="o">=</span><span class="n">query_embeddings</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="n">source_document</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="c1"># Cache the results and return</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_sim</span> <span class="o">=</span> <span class="n">similarity_results</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="k">return</span> <span class="n">similarity_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.run" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">query_prompt_name</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="n">source_prompt_name</span><span class="o">=</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline.two_stage.ClassificationPipelineWithCandidategeneration.run" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Run the full pipeline: generate candidates and classify them.
Returns a dictionary mapping query segment IDs to lists of
(source segment, similarity score, P(positive)) tuples.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/two_stage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">query</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">Document</span><span class="p">,</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">query_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">source_prompt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FullDict</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">    Run the full pipeline: generate candidates and classify them.</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">    Returns a dictionary mapping query segment IDs to lists of</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">    (source segment, similarity score, P(positive)) tuples.</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">similarity_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_candidates</span><span class="p">(</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">query_prompt_name</span><span class="o">=</span><span class="n">query_prompt_name</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">source_prompt_name</span><span class="o">=</span><span class="n">source_prompt_name</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_candidates</span><span class="p">(</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">candidates</span><span class="o">=</span><span class="n">similarity_dict</span><span class="p">,</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="type-definitions">Type Definitions<a class="headerlink" href="#type-definitions" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="locisimiles.pipeline._types"></a>
    <div class="doc doc-contents first">

        <p>Shared type definitions and utilities for pipeline modules.</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="locisimiles.pipeline._types.pretty_print" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">pretty_print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></code>

<a href="#locisimiles.pipeline._types.pretty_print" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Human-friendly dump of <em>run()</em> output.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/locisimiles/pipeline/_types.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">pretty_print</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="n">FullDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Human-friendly dump of *run()* output.&quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">▶ Query segment </span><span class="si">{</span><span class="n">qid</span><span class="si">!r}</span><span class="s2">:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">for</span> <span class="n">src_seg</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">ppos</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="n">sim_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim</span><span class="si">:</span><span class="s2">+.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">src_seg</span><span class="o">.</span><span class="n">id</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2">  sim=</span><span class="si">{</span><span class="n">sim_str</span><span class="si">}</span><span class="s2">  P(pos)=</span><span class="si">{</span><span class="n">ppos</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>